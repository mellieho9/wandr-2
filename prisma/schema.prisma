// Prisma schema for Social Video Processor
// This file defines the database models and relationships

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider             = "prisma-client-py"
  recursive_type_depth = 5
}

model User {
  id                Int               @id @default(autoincrement())
  oauthId           String            @unique @map("oauth_id")
  notionAccessToken String            @map("notion_access_token")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  notionSchemas     NotionSchema[]
  linkDatabases     LinkDatabase[]
  processingQueue   ProcessingQueue[]

  @@map("users")
}

model NotionSchema {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  dbId          String   @map("db_id")
  tag           String
  schemaData    Json     @map("schema")
  prompt        String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tag])
  @@index([userId])
  @@index([userId, tag])
  @@map("notion_schemas")
}

model VideoContent {
  id            Int      @id @default(autoincrement())
  linkEntryId   String   @unique @map("link_entry_id")
  transcription String?
  ocrContent    String?  @map("ocr_content")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("video_contents")
}

model LinkDatabase {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique @map("user_id")
  dbId      String   @map("db_id")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("link_databases")
}

model ProcessingQueue {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  linkEntryId  String   @map("link_entry_id")
  url          String
  tag          String
  status       String   @default("queued")
  retryCount   Int      @default(0) @map("retry_count")
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
  @@map("processing_queue")
}
